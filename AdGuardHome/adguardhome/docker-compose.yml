volumes:
  adguardhome_work:

services:
  resolved-fix:
    image: alpine:latest
    container_name: adguardhome-resolved-fix
    privileged: true
    network_mode: host
    pid: host
    volumes:
      - /etc:/host_etc
      - /run:/host_run
      - /proc:/host_proc
    command: >
      sh -c '
      echo "Checking for systemd-resolved conflicts...";
      if [ -f /host_etc/systemd/resolved.conf ] && (pgrep -x systemd-resolve > /dev/null 2>&1 || pgrep systemd-resolved > /dev/null 2>&1); then
        echo "systemd-resolved detected, applying fix...";
        mkdir -p /host_etc/systemd/resolved.conf.d;
        echo "[Resolve]" > /host_etc/systemd/resolved.conf.d/adguardhome.conf;
        echo "DNS=127.0.0.1" >> /host_etc/systemd/resolved.conf.d/adguardhome.conf;
        echo "DNSStubListener=no" >> /host_etc/systemd/resolved.conf.d/adguardhome.conf;
        if [ -f /host_etc/resolv.conf ] && [ ! -L /host_etc/resolv.conf ]; then
          echo "Backing up resolv.conf...";
          cp /host_etc/resolv.conf /host_etc/resolv.conf.backup;
        fi;
        if [ -f /host_run/systemd/resolve/resolv.conf ]; then
          echo "Creating resolv.conf symlink...";
          ln -sf /run/systemd/resolve/resolv.conf /host_etc/resolv.conf;
        fi;
        echo "Attempting to reload systemd-resolved...";
        if command -v nsenter > /dev/null 2>&1; then
          nsenter --target 1 --mount --uts --ipc --net --pid systemctl reload-or-restart systemd-resolved && echo "Successfully reloaded systemd-resolved" || echo "Failed to reload systemd-resolved, you may need to run manually: systemctl reload-or-restart systemd-resolved";
        else
          echo "nsenter not available. Please run manually: systemctl reload-or-restart systemd-resolved";
        fi;
      else
        echo "No systemd-resolved conflict detected or systemd-resolved not running.";
        echo "Checking if port 53 is in use...";
        if nsenter --target 1 --mount --uts --ipc --net --pid ss -tulnp 2>/dev/null | grep :53; then
          echo "WARNING: Port 53 is in use. AdGuard Home may fail to start.";
        else
          echo "Port 53 appears to be free.";
        fi;
      fi
      '
    restart: "no"

  dns-provision:
    image: mikefarah/yq:latest
    container_name: adguardhome-dns-provision
    volumes:
      - /mnt/sdcard/adguardhome:/config
    entrypoint: ["sh", "-c"]
    command:
      - |
        echo "=== AdGuard Home DNS Provisioning ===";
        CONFIG_FILE="/config/AdGuardHome.yaml";
        TACHYON_IP=192.168.68.73;
        echo "Device IP: $$TACHYON_IP";
        echo "Looking for config at: $$CONFIG_FILE";
        ls -la /config/ || echo "Cannot list /config";
        
        if [ ! -f "$$CONFIG_FILE" ]; then
          echo "Config not found, skipping (will be created on first AdGuard run).";
          exit 0;
        fi;
        
        echo "Config found, checking rewrites...";
        
        # Add wildcard domain
        WILDCARD="*.tachyon.local";
        if yq -e ".filtering.rewrites[] | select(.domain == \"$$WILDCARD\")" "$$CONFIG_FILE" > /dev/null 2>&1; then
          echo "Rewrite for $$WILDCARD already exists.";
        else
          echo "Adding DNS rewrite: $$WILDCARD -> $$TACHYON_IP";
          yq -i ".filtering.rewrites += [{\"domain\": \"$$WILDCARD\", \"answer\": \"$$TACHYON_IP\", \"enabled\": true}]" "$$CONFIG_FILE";
          sync;
        fi;
        
        # Add wildcard domain for internal.keepdream.in
        WILDCARD_INTERNAL="*.internal.keepdream.in";
        if yq -e ".filtering.rewrites[] | select(.domain == \"$$WILDCARD_INTERNAL\")" "$$CONFIG_FILE" > /dev/null 2>&1; then
          echo "Rewrite for $$WILDCARD_INTERNAL already exists.";
        else
          echo "Adding DNS rewrite: $$WILDCARD_INTERNAL -> $$TACHYON_IP";
          yq -i ".filtering.rewrites += [{\"domain\": \"$$WILDCARD_INTERNAL\", \"answer\": \"$$TACHYON_IP\", \"enabled\": true}]" "$$CONFIG_FILE";
          sync;
        fi;
        
        # Add base domain
        if yq -e ".filtering.rewrites[] | select(.domain == \"tachyon.local\")" "$$CONFIG_FILE" > /dev/null 2>&1; then
          echo "Rewrite for tachyon.local already exists.";
        else
          echo "Adding DNS rewrite: tachyon.local -> $$TACHYON_IP";
          yq -i ".filtering.rewrites += [{\"domain\": \"tachyon.local\", \"answer\": \"$$TACHYON_IP\", \"enabled\": true}]" "$$CONFIG_FILE";
          sync;
        fi;
        
        echo "Forcing filesystem sync...";
        sync;
        sleep 1;
        
        echo "DNS provisioning complete.";
        echo "Current rewrites:";
        yq ".filtering.rewrites" "$$CONFIG_FILE";
    restart: "no"

  adguardhome:
    image: adguard/adguardhome:latest
    container_name: adguardhome
    restart: unless-stopped
    depends_on:
      resolved-fix:
        condition: service_started
      dns-provision:
        condition: service_completed_successfully
    
    environment:
      - TZ=UTC
    
    networks:
      - proxy-network
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "3000:3000/tcp"
      # - "80:80/tcp"
      # - "443:443/tcp"
      # - "443:443/udp"
      # - "853:853/tcp"
      # - "853:853/udp"
      # - "5443:5443/tcp"
      # - "5443:5443/udp"
    
    volumes:
      - adguardhome_work:/opt/adguardhome/work
      - /mnt/sdcard/adguardhome:/opt/adguardhome/conf
    
    cap_add:
      - NET_ADMIN
      - NET_BIND_SERVICE

networks:
  proxy-network:
    external: true
