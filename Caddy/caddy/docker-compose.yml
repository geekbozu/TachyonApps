services:
  mount-check:
    image: alpine:latest
    container_name: caddy-mount-check
    volumes:
      - /mnt/sdcard:/mnt/sdcard:ro
    command: >
      sh -c '
      echo "Waiting for SD card mount...";
      for i in 1 2 3 4 5; do
        if mountpoint -q /mnt/sdcard 2>/dev/null && [ -d /mnt/sdcard ] && [ "$$(ls -A /mnt/sdcard 2>/dev/null | wc -l)" -gt 0 ]; then
          echo "SD card mount verified.";
          exit 0;
        fi;
        echo "Mount not ready, waiting 5 seconds... (attempt $$i/5)";
        sleep 5;
      done;
      echo "ERROR: SD card mount not available after 25 seconds.";
      echo "Please ensure the sdcard-mount container is running.";
      exit 1;
      '
    restart: "no"

  caddy-config:
    image: alpine:latest
    container_name: caddy-config
    volumes:
      - /mnt/sdcard/caddy:/caddy
    depends_on:
      mount-check:
        condition: service_completed_successfully
    command:
      - sh
      - -c
      - |
        echo "=== Writing Caddyfile ===";
        mkdir -p /caddy/etc;
        cat > /caddy/etc/Caddyfile << 'EOF'
        {
          local_certs
          skip_install_trust
        }

        https://tachyon.local {
          redir https://kanban.tachyon.local permanent
        }

        https://kanban.tachyon.local {
          reverse_proxy veritas-kanban:3001
        }

        https://adguard.tachyon.local {
          reverse_proxy adguardhome:3000
        }

        https://wireguard.tachyon.local {
          reverse_proxy wg-easy:51821
        }

        https://notebook.tachyon.local {
          reverse_proxy open-notebook:8502
        }

        https://notebook-api.tachyon.local {
          reverse_proxy open-notebook:5055
        }
        EOF
        # Remove leading whitespace from each line
        sed -i 's/^        //' /caddy/etc/Caddyfile;
        echo "Caddyfile written:";
        cat /caddy/etc/Caddyfile;
    restart: "no"

  caddy:
    image: caddy:2-alpine
    container_name: caddy
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"  # HTTP/3
    volumes:
      - /mnt/sdcard/caddy/etc/Caddyfile:/etc/caddy/Caddyfile:ro
      - /mnt/sdcard/caddy/data:/data
      - /mnt/sdcard/caddy/config:/config
    networks:
      - proxy-network
    depends_on:
      mount-check:
        condition: service_completed_successfully
      caddy-config:
        condition: service_completed_successfully
    restart: unless-stopped

networks:
  proxy-network:
    name: proxy-network
    driver: bridge
