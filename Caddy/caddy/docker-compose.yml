services:
  mount-check:
    image: alpine:latest
    container_name: caddy-mount-check
    volumes:
      - /mnt/sdcard:/mnt/sdcard:ro
    command: >
      sh -c '
      echo "Waiting for SD card mount...";
      for i in 1 2 3 4 5; do
        if mountpoint -q /mnt/sdcard 2>/dev/null && [ -d /mnt/sdcard ] && [ "$$(ls -A /mnt/sdcard 2>/dev/null | wc -l)" -gt 0 ]; then
          echo "SD card mount verified.";
          exit 0;
        fi;
        echo "Mount not ready, waiting 5 seconds... (attempt $$i/5)";
        sleep 5;
      done;
      echo "ERROR: SD card mount not available after 25 seconds.";
      echo "Please ensure the sdcard-mount container is running.";
      exit 1;
      '
    restart: "no"

  caddy-config:
    image: alpine:latest
    container_name: caddy-config
    volumes:
      - /mnt/sdcard/caddy:/caddy
    depends_on:
      mount-check:
        condition: service_completed_successfully
    command:
      - sh
      - -c
      - |
        echo "=== Writing Caddyfile ===";
        mkdir -p /caddy/etc;
        cat > /caddy/etc/Caddyfile << 'EOF'
        {
          email {env.LETSENCRYPT_EMAIL}
          acme_dns porkbun {
            api_key {env.PORKBUN_API_KEY}
            api_secret_key {env.PORKBUN_SECRET_KEY}
          }
        }

        *.internal.keepdream.in {

          @adguard host adguard.internal.keepdream.in
          handle @adguard {
            reverse_proxy adguardhome:3000
          }

          @wireguard host wireguard.internal.keepdream.in
          handle @wireguard {
            reverse_proxy wg-easy:51821
          }

          @notebook host notebook.internal.keepdream.in
          handle @notebook {
            reverse_proxy open-notebook:8502
          }

          @notebook-api host notebook-api.internal.keepdream.in
          handle @notebook-api {
            reverse_proxy open-notebook:5055
          }

          @flux host flux.internal.keepdream.in
          handle @flux {
            reverse_proxy flux-web:3000
          }

          handle {
            respond "Not Found" 404
          }
        }

        internal.keepdream.in {
          redir https://flux.internal.keepdream.in permanent
        }
        EOF
        # Remove leading whitespace from each line
        sed -i 's/^        //' /caddy/etc/Caddyfile;
        echo "Caddyfile written:";
        cat /caddy/etc/Caddyfile;
    restart: "no"

  caddy:
    build: .
    image: caddy-porkbun:latest
    container_name: caddy
    env_file:
      - /mnt/sdcard/caddy/.env
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"  # HTTP/3
    volumes:
      - /mnt/sdcard/caddy/etc/Caddyfile:/etc/caddy/Caddyfile:ro
      - /mnt/sdcard/caddy/data:/data
      - /mnt/sdcard/caddy/config:/config
    networks:
      - proxy-network
    depends_on:
      mount-check:
        condition: service_completed_successfully
      caddy-config:
        condition: service_completed_successfully
    restart: unless-stopped

networks:
  proxy-network:
    name: proxy-network
    driver: bridge
